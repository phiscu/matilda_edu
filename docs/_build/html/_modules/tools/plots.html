

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tools.plots &mdash; Matilda ONLINE 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Matilda ONLINE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">MATILDA Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Tools Module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Matilda ONLINE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tools.plots</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tools.plots</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scienceplots</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.legend</span><span class="w"> </span><span class="kn">import</span> <span class="n">Legend</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">probscale</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tools.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_era5l</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">configparser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tools.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">parquet_to_dict</span><span class="p">,</span> <span class="n">read_yaml</span><span class="p">,</span> <span class="n">pickle_to_dict</span><span class="p">,</span> <span class="n">get_si</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tools.indicators</span><span class="w"> </span><span class="kn">import</span> <span class="n">indicator_vars</span><span class="p">,</span> <span class="n">custom_df_indicators</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Rectangle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dash</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dash</span><span class="p">,</span> <span class="n">dcc</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Output</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jupyter_server</span><span class="w"> </span><span class="kn">import</span> <span class="n">serverapp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.io</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pio</span>

<span class="c1"># Use Seaborn white style</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>

<span class="c1"># Use LaTeX for rendering text</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>     <span class="c1"># overwrites several font settings</span>

<span class="c1"># Set consistent font type, size, and weight</span>
<span class="c1">#plt.rcParams[&#39;font.size&#39;] = 14</span>
<span class="c1">#plt.rcParams[&#39;font.family&#39;] = &#39;serif&#39;</span>
<span class="c1">#plt.rcParams[&#39;font.weight&#39;] = &#39;bold&#39;</span>

<span class="c1"># Set figure and subplot title size and weight</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.titlesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.titleweight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;heavy&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.titlesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">18</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.titleweight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span>

<span class="c1"># Set consistent grid style</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;grid.linestyle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;grid.color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;grid.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="c1"># Set axis style</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span><span class="o">=</span> <span class="mi">15</span>
<span class="c1">#plt.rcParams[&#39;axes.linewidth&#39;] = 1.0</span>

<span class="c1"># get style for matplotlib plots</span>
<span class="c1"># plt_style = ast.literal_eval(config[&#39;CONFIG&#39;][&#39;PLOT_STYLE&#39;])</span>

<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s2">&quot;text.usetex&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;font.family&quot;</span><span class="p">:</span> <span class="s2">&quot;serif&quot;</span><span class="p">,</span>            <span class="c1"># or &#39;sans-serif&#39;, &#39;monospace&#39;, etc.</span>
    <span class="s2">&quot;font.serif&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Computer Modern&quot;</span><span class="p">],</span> <span class="c1"># default LaTeX serif font</span>
<span class="p">})</span>



<div class="viewcode-block" id="df2long">
<a class="viewcode-back" href="../../modules.html#tools.plots.df2long">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">df2long</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">intv_sum</span><span class="o">=</span><span class="s1">&#39;ME&#39;</span><span class="p">,</span> <span class="n">intv_mean</span><span class="o">=</span><span class="s1">&#39;YE&#39;</span><span class="p">,</span> <span class="n">precip</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resamples dataframes and converts them into long format to be passed to seaborn.lineplot().&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">precip</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">intv_sum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">intv_mean</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;prec&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">intv_mean</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;temp&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="cmip_plot">
<a class="viewcode-back" href="../../modules.html#tools.plots.cmip_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cmip_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">precip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">smooth_window</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">agg_level</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span>
              <span class="n">target_label</span><span class="o">=</span><span class="s1">&#39;Target&#39;</span><span class="p">,</span> <span class="n">show_target_label</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots climate model and target data using moving window smoothing.&quot;&quot;&quot;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">smooth_window</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">smooth_window</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;smooth_window must be a number, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">smooth_window</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">precip</span><span class="p">:</span>
        <span class="c1"># Define aggregation frequency based on agg_level</span>
        <span class="k">if</span> <span class="n">agg_level</span> <span class="o">==</span> <span class="s1">&#39;monthly&#39;</span><span class="p">:</span>
            <span class="n">resample_freq</span> <span class="o">=</span> <span class="s1">&#39;ME&#39;</span>
            <span class="n">smooth_window_units</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">smooth_window</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span>  <span class="c1"># Convert years to months</span>
        <span class="k">elif</span> <span class="n">agg_level</span> <span class="o">==</span> <span class="s1">&#39;annual&#39;</span><span class="p">:</span>
            <span class="n">resample_freq</span> <span class="o">=</span> <span class="s1">&#39;YE&#39;</span>
            <span class="n">smooth_window_units</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">smooth_window</span><span class="p">)</span>  <span class="c1"># Smooth window directly in years</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid agg_level: </span><span class="si">{</span><span class="n">agg_level</span><span class="si">}</span><span class="s2">. Use &#39;monthly&#39; or &#39;annual&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Convert daily data to specified aggregation level (monthly or annual)</span>
        <span class="n">df_agg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">resample_freq</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">target_agg</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="s1">&#39;prec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">resample_freq</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Apply rolling mean on aggregated data</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_agg</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">smooth_window_units</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
        <span class="n">era_plot</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">target_agg</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">smooth_window_units</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> 
                            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">target_label</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Convert smoothing window from years to days for temperature</span>
        <span class="n">smooth_window_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">smooth_window</span> <span class="o">*</span> <span class="mf">365.25</span><span class="p">)</span>  <span class="c1"># Account for leap years</span>
        
        <span class="c1"># Apply rolling mean on daily data</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">smooth_window_days</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
        <span class="n">era_plot</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">smooth_window_days</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> 
                            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">target_label</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_target_label</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">era_plot</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="c1"># Set y-labels for left-side plots using the corrected column check</span>
    <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_subplotspec</span><span class="p">()</span><span class="o">.</span><span class="n">colspan</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">precip</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;[mm]&#39;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;[K]&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="cmip_plot_combined">
<a class="viewcode-back" href="../../modules.html#tools.plots.cmip_plot_combined">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cmip_plot_combined</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">precip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">agg_level</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">smooth_window</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                       <span class="n">target_label</span><span class="o">=</span><span class="s1">&#39;Target&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fig_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Combines multiple subplots of climate data in different scenarios before and after bias adjustment.</span>
<span class="sd">    Uses moving window smoothing in years instead of days.&quot;&quot;&quot;</span>
    
    <span class="n">figure</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="s2">&quot;col&quot;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    
    <span class="n">t_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span> <span class="s1">&#39;smooth_window&#39;</span><span class="p">:</span> <span class="n">smooth_window</span><span class="p">,</span> <span class="s1">&#39;target_label&#39;</span><span class="p">:</span> <span class="n">target_label</span><span class="p">}</span>
    <span class="n">p_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span> <span class="s1">&#39;smooth_window&#39;</span><span class="p">:</span> <span class="n">smooth_window</span><span class="p">,</span> <span class="s1">&#39;target_label&#39;</span><span class="p">:</span> <span class="n">target_label</span><span class="p">,</span>
                <span class="s1">&#39;precip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;agg_level&#39;</span><span class="p">:</span> <span class="n">agg_level</span><span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">precip</span><span class="p">:</span>
        <span class="n">cmip_plot</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SSP2_raw&#39;</span><span class="p">],</span> <span class="n">show_target_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SSP2 raw&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">t_kwargs</span><span class="p">)</span>
        <span class="n">cmip_plot</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SSP2_adjusted&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SSP2 adjusted&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">t_kwargs</span><span class="p">)</span>
        <span class="n">cmip_plot</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SSP5_raw&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SSP5 raw&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">t_kwargs</span><span class="p">)</span>
        <span class="n">cmip_plot</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SSP5_adjusted&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SSP5 adjusted&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">t_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">smooth_window</span><span class="si">}</span><span class="s1"> Year Rolling Mean of </span><span class="si">{</span><span class="n">agg_level</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s1"> Precipitation&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmip_plot</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SSP2_raw&#39;</span><span class="p">],</span> <span class="n">show_target_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SSP2 raw&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">p_kwargs</span><span class="p">)</span>
        <span class="n">cmip_plot</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SSP2_adjusted&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SSP2 adjusted&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">p_kwargs</span><span class="p">)</span>
        <span class="n">cmip_plot</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SSP5_raw&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SSP5 raw&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">p_kwargs</span><span class="p">)</span>
        <span class="n">cmip_plot</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SSP5_adjusted&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SSP5 adjusted&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">p_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">smooth_window</span><span class="si">}</span><span class="s1"> Year Rolling Mean of Air Temperature&#39;</span><span class="p">)</span>

    <span class="n">figure</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SSP5_adjusted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;expand&quot;</span><span class="p">)</span>
    <span class="n">figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">figure</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.92</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fig_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


            

<div class="viewcode-block" id="vplots">
<a class="viewcode-back" href="../../modules.html#tools.plots.vplots">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">vplots</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">target_label</span><span class="o">=</span><span class="s1">&#39;Target&#39;</span><span class="p">,</span> <span class="n">precip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fig_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates violin plots of the kernel density estimation for all models before and after bias adjustment.&quot;&quot;&quot;</span>

    <span class="n">period</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="s1">&#39;1979-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2022-12-31&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">precip</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;prec&#39;</span>
        <span class="n">var_label</span> <span class="o">=</span> <span class="s1">&#39;Annual Precipitation&#39;</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39; [mm]&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;temp&#39;</span>
        <span class="n">var_label</span> <span class="o">=</span> <span class="s1">&#39;Mean Annual Air Temperature&#39;</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39; [K]&#39;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">before</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">before</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">before</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">period</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">before</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">target_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">period</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">after</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">after</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">after</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">period</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">after</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">target_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">period</span><span class="p">]</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="n">outer</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">inner</span> <span class="o">=</span> <span class="n">outer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subgridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">inner</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;col&#39;</span><span class="p">)</span>


    <span class="n">all_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df2long</span><span class="p">(</span><span class="n">before</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">precip</span><span class="o">=</span><span class="n">precip</span><span class="p">,</span> <span class="n">intv_sum</span><span class="o">=</span><span class="s1">&#39;YE&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">before</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span> <span class="o">+</span>
                         <span class="p">[</span><span class="n">df2long</span><span class="p">(</span><span class="n">after</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">precip</span><span class="o">=</span><span class="n">precip</span><span class="p">,</span> <span class="n">intv_sum</span><span class="o">=</span><span class="s1">&#39;YE&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">after</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">all_data</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">)</span> <span class="k">if</span> <span class="n">precip</span> <span class="k">else</span> <span class="p">(</span><span class="n">xmin</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># ---------------- &quot;Before&quot; Plots ----------------</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">before</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df2long</span><span class="p">(</span><span class="n">before</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">precip</span><span class="o">=</span><span class="n">precip</span><span class="p">,</span> <span class="n">intv_sum</span><span class="o">=</span><span class="s1">&#39;YE&#39;</span><span class="p">)</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                       <span class="n">density_norm</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">bw_adjust</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;husl&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># Set y-axis labels manually</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">)</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

        <span class="c1"># Separate Reanalysis data</span>
        <span class="n">tick_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">before_last</span> <span class="o">=</span> <span class="n">tick_number</span> <span class="o">-</span> <span class="mf">1.5</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">before_last</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Before Scaled Distribution Mapping&#39;</span><span class="p">)</span>        

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">var_label</span> <span class="o">+</span> <span class="n">unit</span><span class="p">)</span>

    <span class="c1"># ---------------- &quot;After&quot; Plots ----------------</span>
    <span class="n">inner</span> <span class="o">=</span> <span class="n">outer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">subgridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">inner</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;col&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">after</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df2long</span><span class="p">(</span><span class="n">after</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">precip</span><span class="o">=</span><span class="n">precip</span><span class="p">,</span> <span class="n">intv_sum</span><span class="o">=</span><span class="s1">&#39;YE&#39;</span><span class="p">)</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                       <span class="n">density_norm</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">bw_adjust</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;husl&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">)</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Separate Reanalysis data</span>
        <span class="n">tick_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">before_last</span> <span class="o">=</span> <span class="n">tick_number</span> <span class="o">-</span> <span class="mf">1.5</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">before_last</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">axis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;After Scaled Distribution Mapping&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">var_label</span> <span class="o">+</span> <span class="n">unit</span><span class="p">)</span>

    <span class="c1"># ---------------- Global Title ----------------</span>
    <span class="n">starty</span> <span class="o">=</span> <span class="n">period</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">endy</span> <span class="o">=</span> <span class="n">period</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Kernel Density Estimation of &#39;</span> <span class="o">+</span> <span class="n">var_label</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">starty</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">endy</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.93</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">fig_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

        

<div class="viewcode-block" id="cmip_plot_ensemble">
<a class="viewcode-back" href="../../modules.html#tools.plots.cmip_plot_ensemble">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cmip_plot_ensemble</span><span class="p">(</span><span class="n">cmip</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">precip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">intv_sum</span><span class="o">=</span><span class="s1">&#39;ME&#39;</span><span class="p">,</span> <span class="n">intv_mean</span><span class="o">=</span><span class="s1">&#39;YE&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fig_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the multi-model mean of climate scenarios including the 90% confidence interval.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cmip: dict</span>
<span class="sd">        A dictionary with keys representing the different CMIP6 models and scenarios as pandas dataframes</span>
<span class="sd">        containing data of temperature and/or precipitation.</span>
<span class="sd">    target: pandas.DataFrame</span>
<span class="sd">        Dataframe containing the historical reanalysis data.</span>
<span class="sd">    precip: bool</span>
<span class="sd">        If True, plot the mean precipitation. If False, plot the mean temperature. Default is False.</span>
<span class="sd">    intv_sum: str</span>
<span class="sd">        Interval for precipitation sums. Default is monthly (&#39;ME&#39;).</span>
<span class="sd">    intv_mean: str</span>
<span class="sd">        Interval for the mean of temperature data or precipitation sums. Default is annual (&#39;YE&#39;).</span>
<span class="sd">    figsize: tuple</span>
<span class="sd">        Figure size for the plot. Default is (8,6).</span>
<span class="sd">    show: bool</span>
<span class="sd">        If True, show the resulting plot. If False, do not show it. Default is True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">figure</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Define color palette</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="s1">&#39;dodgerblue&#39;</span><span class="p">]</span>
    <span class="c1"># create a new dictionary with the same keys but new values from the list</span>
    <span class="n">col_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cmip</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">colors</span><span class="p">)}</span>
    
    <span class="c1">#figure.tight_layout(rect=[0, 0.02, 1, 0.95])  # Make some room at the bottom</span>

    <span class="k">if</span> <span class="n">precip</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cmip</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df2long</span><span class="p">(</span><span class="n">cmip</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">intv_sum</span><span class="o">=</span><span class="n">intv_sum</span><span class="p">,</span> <span class="n">intv_mean</span><span class="o">=</span><span class="n">intv_mean</span><span class="p">,</span> <span class="n">precip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;prec&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col_dict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;[mm]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">intv_sum</span><span class="o">==</span><span class="s1">&#39;ME&#39;</span><span class="p">:</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Mean Monthly Precipitation&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">intv_sum</span><span class="o">==</span><span class="s1">&#39;YE&#39;</span><span class="p">:</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Mean Annual Precipitation&#39;</span><span class="p">)</span>
        <span class="n">target_plot</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">intv_sum</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">intv_mean</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ERA5&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cmip</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df2long</span><span class="p">(</span><span class="n">cmip</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">intv_mean</span><span class="o">=</span><span class="n">intv_mean</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col_dict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;[K]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">intv_mean</span><span class="o">==</span><span class="s1">&#39;10YE&#39;</span><span class="p">:</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Mean 10y Air Temperature&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">intv_mean</span> <span class="o">==</span> <span class="s1">&#39;YE&#39;</span><span class="p">:</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Mean Annual Air Temperature&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">intv_mean</span> <span class="o">==</span> <span class="s1">&#39;ME&#39;</span><span class="p">:</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Mean Monthly Air Temperature&#39;</span><span class="p">)</span>
        <span class="n">target_plot</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">intv_mean</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ERA5&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;SSP2 raw&#39;</span><span class="p">,</span> <span class="s1">&#39;_ci1&#39;</span><span class="p">,</span> <span class="s1">&#39;SSP2 adjusted&#39;</span><span class="p">,</span> <span class="s1">&#39;_ci2&#39;</span><span class="p">,</span> <span class="s1">&#39;SSP5 raw&#39;</span><span class="p">,</span> <span class="s1">&#39;_ci3&#39;</span><span class="p">,</span> <span class="s1">&#39;SSP5 adjusted&#39;</span><span class="p">,</span> <span class="s1">&#39;_ci4&#39;</span><span class="p">],</span>
                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper center&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.39</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.14</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># First legend --&gt; Workaround as seaborn lists CIs in legend</span>
    <span class="n">leg</span> <span class="o">=</span> <span class="n">Legend</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">target_plot</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;ERA5L&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.89</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.14</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Second legend (ERA5)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">leg</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>  <span class="c1"># Dashed lines with transparency</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">fig_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;always&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="prob_plot">
<a class="viewcode-back" href="../../modules.html#tools.plots.prob_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prob_plot</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">corrected</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Temperature [K]&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combines probability plots of climate model data before and after bias adjustment</span>
<span class="sd">    and the target data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    original : pandas.DataFrame</span>
<span class="sd">        The original climate model data.</span>
<span class="sd">    target : pandas.DataFrame</span>
<span class="sd">        The target data.</span>
<span class="sd">    corrected : pandas.DataFrame</span>
<span class="sd">        The climate model data after bias adjustment.</span>
<span class="sd">    ax : matplotlib.axes.Axes</span>
<span class="sd">        The axes on which to plot the probability plot.</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        The title of the plot. Default is None.</span>
<span class="sd">    ylabel : str, optional</span>
<span class="sd">        The label for the y-axis. Default is &quot;Temperature [K]&quot;.</span>
<span class="sd">    **kwargs : dict, optional</span>
<span class="sd">        Additional keyword arguments passed to the probscale.probplot() function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig : matplotlib Figure</span>
<span class="sd">        The generated figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">scatter_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="n">common_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">plottype</span><span class="o">=</span><span class="s2">&quot;qq&quot;</span><span class="p">,</span> <span class="n">problabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">datalabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">scatter_kws</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;original&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">probscale</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">scatter_kws</span><span class="o">=</span><span class="n">scatter_kws</span><span class="p">,</span> <span class="o">**</span><span class="n">common_opts</span><span class="p">)</span>

    <span class="n">scatter_kws</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">probscale</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">scatter_kws</span><span class="o">=</span><span class="n">scatter_kws</span><span class="p">,</span> <span class="o">**</span><span class="n">common_opts</span><span class="p">)</span>

    <span class="n">scatter_kws</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;adjusted&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">probscale</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">corrected</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">scatter_kws</span><span class="o">=</span><span class="n">scatter_kws</span><span class="p">,</span> <span class="o">**</span><span class="n">common_opts</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Standard Normal Quantiles&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">score</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">corrected</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;R = </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="pp_matrix">
<a class="viewcode-back" href="../../modules.html#tools.plots.pp_matrix">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pp_matrix</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">corrected</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">precip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fig_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arranges the prob_plots of all CMIP6 models in a matrix and adds the R score.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    original : pandas.DataFrame</span>
<span class="sd">        The original climate model data.</span>
<span class="sd">    target : pandas.DataFrame</span>
<span class="sd">        The target data.</span>
<span class="sd">    corrected : pandas.DataFrame</span>
<span class="sd">        The climate model data after bias adjustment.</span>
<span class="sd">    scenario : str, optional</span>
<span class="sd">        The climate scenario to be added to the plot title.</span>
<span class="sd">    nrow : int, optional</span>
<span class="sd">        The number of rows in the plot matrix. Default is 7.</span>
<span class="sd">    ncol : int, optional</span>
<span class="sd">        The number of columns in the plot matrix. Default is 5.</span>
<span class="sd">    precip : bool, optional</span>
<span class="sd">        Indicates whether the data is precipitation data. Default is False.</span>
<span class="sd">    show : bool, optional</span>
<span class="sd">        Indicates whether to display the plot. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">period</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="s1">&#39;1979-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2022-12-31&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">precip</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;Precipitation&#39;</span>
        <span class="n">var_label</span> <span class="o">=</span> <span class="s1">&#39;Monthly &#39;</span> <span class="o">+</span> <span class="n">var</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39; [mm]&#39;</span>
        <span class="n">original</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;ME&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;ME&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">corrected</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;ME&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;Temperature&#39;</span>
        <span class="n">var_label</span> <span class="o">=</span> <span class="s1">&#39;Daily Mean &#39;</span> <span class="o">+</span> <span class="n">var</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39; [K]&#39;</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">prob_plot</span><span class="p">(</span><span class="n">original</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">period</span><span class="p">],</span> <span class="n">target</span><span class="p">[</span><span class="n">period</span><span class="p">],</span>
                  <span class="n">corrected</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">period</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">var</span> <span class="o">+</span> <span class="n">unit</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;original (CMIP6 raw)&#39;</span><span class="p">,</span> <span class="s1">&#39;target (ERA5-Land)&#39;</span><span class="p">,</span> <span class="s1">&#39;adjusted (CMIP6 after SDM)&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span>
               <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.96</span><span class="p">,</span> <span class="mf">0.024</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="n">starty</span> <span class="o">=</span> <span class="n">period</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">endy</span> <span class="o">=</span> <span class="n">period</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">scenario</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Probability Plots of CMIP6 and ERA5-Land &#39;</span> <span class="o">+</span> <span class="n">var_label</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">starty</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">endy</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Probability Plots of CMIP6 (&#39;</span> <span class="o">+</span> <span class="n">scenario</span> <span class="o">+</span> <span class="s1">&#39;) and ERA5-Land &#39;</span> <span class="o">+</span> <span class="n">var_label</span> <span class="o">+</span>
                     <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">starty</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">endy</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.93</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fig_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">MatildaSummary</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_input</span><span class="p">,</span> <span class="n">dir_output</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_input</span> <span class="o">=</span> <span class="n">dir_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_output</span> <span class="o">=</span> <span class="n">dir_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arrow_props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matilda_scenarios</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_era5</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runoff</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaporation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precipitation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">glacier_area</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snow_melt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ice_melt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">off_melt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_diff</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load all necessary data for plotting&quot;&quot;&quot;</span>
        <span class="c1"># Load observation data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_input</span> <span class="o">+</span> <span class="s1">&#39;obs_runoff_example.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Qobs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Qobs&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">86400</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;area_cat&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>

        <span class="c1"># Load ERA5 data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_era5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_output</span> <span class="o">+</span> <span class="s1">&#39;ERA5L.csv&#39;</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span>
            <span class="s1">&#39;usecols&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;prec&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">],</span>
            <span class="s1">&#39;index_col&#39;</span><span class="p">:</span> <span class="s1">&#39;dt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;parse_dates&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]})</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;temp&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;prec&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>

        <span class="c1"># Adjust start date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_era5</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_era5</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_era5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_era5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_era5</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="s1">&#39;2000-01-01&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="s1">&#39;2000-01-01&#39;</span><span class="p">]</span>

        <span class="c1"># Load climate model data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tas</span> <span class="o">=</span> <span class="n">pickle_to_dict</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_output</span><span class="si">}</span><span class="s2">cmip6/adjusted/tas.pickle&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="n">pickle_to_dict</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_output</span><span class="si">}</span><span class="s2">cmip6/adjusted/pr.pickle&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_startdate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_startdate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">)</span>

        <span class="c1"># Load MATILDA scenarios</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matilda_scenarios</span> <span class="o">=</span> <span class="n">pickle_to_dict</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_output</span><span class="si">}</span><span class="s2">cmip6/adjusted/matilda_scenarios.pickle&quot;</span><span class="p">)</span>
        
        <span class="c1"># Prepare data for plotting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_data_for_plot</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">adjust_startdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adjust start date for dictionaries of dataframes&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_matilda_result_all_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">result_name</span><span class="p">,</span> <span class="n">dict_name</span><span class="o">=</span><span class="s1">&#39;model_output&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract specific result from all models for a given scenario&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">matilda_scenarios</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">dict_name</span><span class="p">][</span><span class="n">result_name</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">key</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">s</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;TIMESTAMP&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s1"> extracted for </span><span class="si">{</span><span class="n">scenario</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_data_for_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare all necessary data for plotting&quot;&quot;&quot;</span>
        <span class="c1"># Extract results from MATILDA scenarios</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runoff</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SSP2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="s1">&#39;SSP2&#39;</span><span class="p">,</span> <span class="s1">&#39;total_runoff&#39;</span><span class="p">),</span>
                      <span class="s1">&#39;SSP5&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="s1">&#39;SSP5&#39;</span><span class="p">,</span> <span class="s1">&#39;total_runoff&#39;</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evaporation</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SSP2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="s1">&#39;SSP2&#39;</span><span class="p">,</span> <span class="s1">&#39;actual_evaporation&#39;</span><span class="p">),</span>
                           <span class="s1">&#39;SSP5&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="s1">&#39;SSP5&#39;</span><span class="p">,</span> <span class="s1">&#39;actual_evaporation&#39;</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">precipitation</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SSP2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="s1">&#39;SSP2&#39;</span><span class="p">,</span> <span class="s1">&#39;total_precipitation&#39;</span><span class="p">),</span>
                             <span class="s1">&#39;SSP5&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="s1">&#39;SSP5&#39;</span><span class="p">,</span> <span class="s1">&#39;total_precipitation&#39;</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">glacier_area</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SSP2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="s1">&#39;SSP2&#39;</span><span class="p">,</span> <span class="s1">&#39;glacier_area&#39;</span><span class="p">,</span> <span class="n">dict_name</span><span class="o">=</span><span class="s1">&#39;glacier_rescaling&#39;</span><span class="p">),</span>
                            <span class="s1">&#39;SSP5&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="s1">&#39;SSP5&#39;</span><span class="p">,</span> <span class="s1">&#39;glacier_area&#39;</span><span class="p">,</span> <span class="n">dict_name</span><span class="o">=</span><span class="s1">&#39;glacier_rescaling&#39;</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">snow_melt</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SSP2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="s1">&#39;SSP2&#39;</span><span class="p">,</span> <span class="s1">&#39;snow_melt_on_glaciers&#39;</span><span class="p">),</span>
                         <span class="s1">&#39;SSP5&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="s1">&#39;SSP5&#39;</span><span class="p">,</span> <span class="s1">&#39;snow_melt_on_glaciers&#39;</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ice_melt</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SSP2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="s1">&#39;SSP2&#39;</span><span class="p">,</span> <span class="s1">&#39;ice_melt_on_glaciers&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;SSP5&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="s1">&#39;SSP5&#39;</span><span class="p">,</span> <span class="s1">&#39;ice_melt_on_glaciers&#39;</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">off_melt</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SSP2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="s1">&#39;SSP2&#39;</span><span class="p">,</span> <span class="s1">&#39;melt_off_glaciers&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;SSP5&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="s1">&#39;SSP5&#39;</span><span class="p">,</span> <span class="s1">&#39;melt_off_glaciers&#39;</span><span class="p">)}</span>

        <span class="c1"># Melt off glacier is always snow melt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snow_melt</span><span class="p">[</span><span class="s1">&#39;SSP2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snow_melt</span><span class="p">[</span><span class="s1">&#39;SSP2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">off_melt</span><span class="p">[</span><span class="s1">&#39;SSP2&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snow_melt</span><span class="p">[</span><span class="s1">&#39;SSP5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snow_melt</span><span class="p">[</span><span class="s1">&#39;SSP5&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">off_melt</span><span class="p">[</span><span class="s1">&#39;SSP5&#39;</span><span class="p">]</span>

        <span class="c1"># Glacier area starts one year earlier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_startdate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glacier_area</span><span class="p">)</span>

        <span class="c1"># Convert Temp from K to C</span>
        <span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;SSP2&#39;</span><span class="p">,</span> <span class="s1">&#39;SSP5&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tas</span><span class="p">[</span><span class="n">scenario</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tas</span><span class="p">[</span><span class="n">scenario</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tas</span><span class="p">[</span><span class="n">scenario</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="mf">273.15</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_era5</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_era5</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">273.15</span>

        <span class="c1"># Process melt data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_melt_data</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_melt_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process and aggregate melt data for plotting&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="p">[</span><span class="s1">&#39;ssp2_avg_snow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snow_melt</span><span class="p">[</span><span class="s1">&#39;SSP2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="p">[</span><span class="s1">&#39;ssp2_avg_ice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_melt</span><span class="p">[</span><span class="s1">&#39;SSP2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;YE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="p">[</span><span class="s1">&#39;ssp5_avg_snow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snow_melt</span><span class="p">[</span><span class="s1">&#39;SSP5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="p">[</span><span class="s1">&#39;ssp5_avg_ice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_melt</span><span class="p">[</span><span class="s1">&#39;SSP5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="p">[</span><span class="s1">&#39;ssp5_avg_off&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">off_melt</span><span class="p">[</span><span class="s1">&#39;SSP5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;YE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">melt_diff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_diff</span><span class="p">[</span><span class="s1">&#39;diff_snow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="p">[</span><span class="s1">&#39;ssp5_avg_snow&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="p">[</span><span class="s1">&#39;ssp2_avg_snow&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melt_diff</span><span class="p">[</span><span class="s1">&#39;diff_ice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="p">[</span><span class="s1">&#39;ssp5_avg_ice&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="p">[</span><span class="s1">&#39;ssp2_avg_ice&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">custom_formatter_abs_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format axis labels for absolute values&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">annotate_final_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">y_axes</span><span class="p">,</span> <span class="n">y_text</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Annotate the final value on a plot&quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">text</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_axes</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="n">y_text</span><span class="p">),</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                    <span class="n">xycoords</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">),</span>
                    <span class="n">arrowprops</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arrow_props</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">annote_final_val_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Annotate final values for all lines on an axis&quot;&quot;&quot;</span>
        <span class="c1"># First collect all y-values</span>
        <span class="n">yvals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">get_ls</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ls</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span> <span class="ow">or</span> <span class="n">ls</span> <span class="o">==</span> <span class="s1">&#39;--&#39;</span><span class="p">:</span>
                <span class="n">ydata</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span>
                <span class="n">yvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Sort them and ensure minimum distance if supplied (lower values have to move)</span>
        <span class="n">yvals</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">yvals</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">yvals</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">yvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">min_dist</span><span class="p">:</span>
                    <span class="n">yvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">yvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">-</span> <span class="n">min_dist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotate_final_val</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yvals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">df2long</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">val_name</span><span class="p">,</span> <span class="n">intv_sum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intv_mean</span><span class="o">=</span><span class="s1">&#39;YE&#39;</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resamples dataframes and converts them into long format for seaborn plots&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">intv_sum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">intv_sum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">intv_mean</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">rolling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">rolling</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cutoff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cutoff</span><span class="p">:]</span>

        <span class="c1"># Adjust the index to assign the first day of the period</span>
        <span class="k">if</span> <span class="n">intv_mean</span> <span class="o">==</span> <span class="s1">&#39;YE&#39;</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">intv_mean</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Reset index to turn the timestamp index into a column</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Melt the dataframe into long format</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="n">val_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_cmip_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_scenarios</span><span class="p">,</span> <span class="n">val_name</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">target_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intv_sum</span><span class="o">=</span><span class="s1">&#39;YE&#39;</span><span class="p">,</span> <span class="n">ylabel_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add CMIP ensemble to a plot&quot;&quot;&quot;</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;dodgerblue&#39;</span><span class="p">]</span>
        <span class="n">col_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">colors</span><span class="p">)}</span>

        <span class="n">linestyles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="s1">&#39;dashed&#39;</span><span class="p">]</span>
        <span class="n">ls_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">linestyles</span><span class="p">)}</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">param_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">df_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df2long</span><span class="p">(</span><span class="n">param_scenarios</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">val_name</span><span class="p">,</span> <span class="n">intv_sum</span><span class="o">=</span><span class="n">intv_sum</span><span class="p">,</span>
                                  <span class="n">intv_mean</span><span class="o">=</span><span class="s1">&#39;YE&#39;</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="n">rolling</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">val_name</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="n">target_color</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">ls_dict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">ylabel_pad</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">target_color</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ensemble_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_scenarios</span><span class="p">,</span> <span class="n">val_name</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intv_sum</span><span class="o">=</span><span class="s1">&#39;YE&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate ensemble maximum with confidence interval&quot;&quot;&quot;</span>
        <span class="n">all_dfs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Step 1: Concatenate all scenarios into one long dataframe</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">param_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">df_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df2long</span><span class="p">(</span><span class="n">param_scenarios</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">val_name</span><span class="p">,</span> <span class="n">intv_sum</span><span class="o">=</span><span class="n">intv_sum</span><span class="p">,</span>
                                  <span class="n">intv_mean</span><span class="o">=</span><span class="s1">&#39;YE&#39;</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="n">rolling</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">)</span>
            <span class="n">df_pred</span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">all_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_pred</span><span class="p">)</span>

        <span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_dfs</span><span class="p">)</span>

        <span class="c1"># Step 2: Compute ensemble mean and 95% CI at each timestamp</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;TIMESTAMP&quot;</span><span class="p">)[</span><span class="n">val_name</span><span class="p">]</span>
        <span class="n">df_ci</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;ci95&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.975</span><span class="p">,</span> <span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]))</span>

        <span class="c1"># Step 3: Add mean + upper confidence bound</span>
        <span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;ci95&#39;</span><span class="p">]</span>

        <span class="c1"># Step 4: Return the maximum of the upper bound</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">df_ci</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the main summary plot with all components&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating MATILDA summary plot...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Set up the figure with gridspec</span>
        <span class="n">gridspec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">figure</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="n">gridspec</span><span class="p">)</span>

        <span class="c1"># ----- Glacierized Area (top panel) -----</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting glacierized area...&quot;</span><span class="p">)</span>
        <span class="n">ax0l</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_cmip_ensemble</span><span class="p">(</span><span class="n">param_scenarios</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">glacier_area</span><span class="p">,</span> <span class="n">val_name</span><span class="o">=</span><span class="s1">&#39;glac_area&#39;</span><span class="p">,</span> 
                       <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Glacierized</span><span class="se">\n</span><span class="s1">Area (km)&#39;</span><span class="p">,</span>
                       <span class="n">ax</span><span class="o">=</span><span class="n">ax0l</span><span class="p">,</span> <span class="n">target_color</span><span class="o">=</span><span class="s1">&#39;darkviolet&#39;</span><span class="p">,</span> <span class="n">ylabel_pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Annotate final glacier values with percentage</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ax0l</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">get_ls</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ls</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span> <span class="ow">or</span> <span class="n">ls</span> <span class="o">==</span> <span class="s1">&#39;--&#39;</span><span class="p">:</span>
                <span class="n">ydata</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span>
                <span class="n">last_val</span> <span class="o">=</span> <span class="n">ydata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">perc_val</span> <span class="o">=</span> <span class="n">last_val</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">ydata</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> km (</span><span class="si">{:.0f}</span><span class="s2">\%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">last_val</span><span class="p">,</span> <span class="n">perc_val</span><span class="p">)</span>
                <span class="n">ax0l</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">label</span><span class="p">,</span>
                            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">last_val</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ydata</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">last_val</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)),</span>
                            <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                            <span class="n">xycoords</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">),</span>
                            <span class="n">arrowprops</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arrow_props</span><span class="p">)</span>

        <span class="c1"># 50% line</span>
        <span class="n">half_y</span> <span class="o">=</span> <span class="n">ax0l</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">ax0l</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">half_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax0l</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">half_y</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;50%&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>

        <span class="c1"># ----- Snow &amp; Ice Melt (second panel) -----</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting snow &amp; ice melt...&quot;</span><span class="p">)</span>
        <span class="n">ax1l</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Create stacked plots for both scenarios</span>
        <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#eaeaea&quot;</span><span class="p">,</span> <span class="s2">&quot;#d1e3ff&quot;</span><span class="p">]</span>  <span class="c1"># Colors for snow and ice melt</span>
        <span class="n">ax1l</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="p">[</span><span class="s1">&#39;ssp5_avg_snow&#39;</span><span class="p">],</span> 
                   <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="p">[</span><span class="s1">&#39;ssp5_avg_ice&#39;</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
        <span class="n">ax1l</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="p">[</span><span class="s1">&#39;ssp2_avg_snow&#39;</span><span class="p">]</span><span class="o">*-</span><span class="mi">1</span><span class="p">,</span> 
                   <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="p">[</span><span class="s1">&#39;ssp2_avg_ice&#39;</span><span class="p">]</span><span class="o">*-</span><span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>

        <span class="n">ax1l</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>  <span class="c1"># Zero line</span>

        <span class="c1"># Plot differences</span>
        <span class="n">ax1l</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">melt_diff</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_diff</span><span class="p">[</span><span class="s1">&#39;diff_snow&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#b6b6b6&#39;</span><span class="p">)</span>
        <span class="n">ax1l</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">melt_diff</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_diff</span><span class="p">[</span><span class="s1">&#39;diff_ice&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#a1bceb&#39;</span><span class="p">)</span>

        <span class="c1"># Auto-scale y-axis to match data range</span>
        <span class="n">ymax_ax1l</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="p">[</span><span class="s1">&#39;ssp5_avg_snow&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="p">[</span><span class="s1">&#39;ssp5_avg_ice&#39;</span><span class="p">]),</span>
                <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="p">[</span><span class="s1">&#39;ssp2_avg_snow&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="p">[</span><span class="s1">&#39;ssp2_avg_ice&#39;</span><span class="p">]))</span>
        <span class="n">ymax_ax1l_upper</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ymax_ax1l</span><span class="o">*</span><span class="mf">1.55</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Add space for legend</span>
        <span class="n">ymax_ax1l_lower</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="o">-</span><span class="n">ymax_ax1l</span><span class="o">*</span><span class="mf">1.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">ax1l</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymax_ax1l_lower</span><span class="p">,</span> <span class="n">ymax_ax1l_upper</span><span class="p">)</span>
        <span class="n">ax1l</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Melt (mm/a)&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Annotate final values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="p">[</span><span class="s1">&#39;ssp5_avg_snow&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotate_final_val</span><span class="p">(</span><span class="n">ax1l</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ymax_ax1l</span><span class="o">*</span><span class="mf">0.3</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="s1">&#39;mm&#39;</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="p">[</span><span class="s1">&#39;ssp5_avg_ice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp5</span><span class="p">[</span><span class="s1">&#39;ssp5_avg_snow&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotate_final_val</span><span class="p">(</span><span class="n">ax1l</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ymax_ax1l</span><span class="o">*</span><span class="mf">0.8</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="s1">&#39;mm&#39;</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="p">[</span><span class="s1">&#39;ssp2_avg_snow&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotate_final_val</span><span class="p">(</span><span class="n">ax1l</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ymax_ax1l</span><span class="o">*-</span><span class="mf">0.3</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="s1">&#39;mm&#39;</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="p">[</span><span class="s1">&#39;ssp2_avg_ice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">melt_ssp2</span><span class="p">[</span><span class="s1">&#39;ssp2_avg_snow&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotate_final_val</span><span class="p">(</span><span class="n">ax1l</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ymax_ax1l</span><span class="o">*-</span><span class="mf">0.8</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="s1">&#39;mm&#39;</span><span class="p">)</span>

        <span class="n">ax1l</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># ----- Runoff &amp; Precipitation (third panel) -----</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting runoff &amp; precipitation...&quot;</span><span class="p">)</span>
        <span class="n">ax2l</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Auto-scale y-axis to match data range</span>
        <span class="n">ymax_ax2l</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_max</span><span class="p">(</span><span class="n">param_scenarios</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runoff</span><span class="p">,</span> <span class="n">val_name</span><span class="o">=</span><span class="s1">&#39;runoff&#39;</span><span class="p">,</span> 
                           <span class="n">rolling</span><span class="o">=</span><span class="n">rolling</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="s1">&#39;2000-12-31&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_max</span><span class="p">(</span><span class="n">param_scenarios</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evaporation</span><span class="p">,</span> <span class="n">val_name</span><span class="o">=</span><span class="s1">&#39;eva&#39;</span><span class="p">,</span> 
                          <span class="n">rolling</span><span class="o">=</span><span class="n">rolling</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="s1">&#39;2000-12-31&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_max</span><span class="p">(</span><span class="n">param_scenarios</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">precipitation</span><span class="p">,</span> <span class="n">val_name</span><span class="o">=</span><span class="s1">&#39;prec&#39;</span><span class="p">,</span> 
                          <span class="n">rolling</span><span class="o">=</span><span class="n">rolling</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="s1">&#39;2000-12-31&#39;</span><span class="p">))</span>
        <span class="n">ymax_ax2l</span> <span class="o">=</span> <span class="n">ymax_ax2l</span> <span class="o">*</span> <span class="mf">1.1</span>  <span class="c1"># Some space for the legend</span>

        <span class="c1"># Plot runoff with observations</span>
        <span class="k">if</span> <span class="n">rolling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obs_rs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Qobs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;YE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">rolling</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obs_rs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Qobs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;YE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_cmip_ensemble</span><span class="p">(</span><span class="n">param_scenarios</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runoff</span><span class="p">,</span> <span class="n">val_name</span><span class="o">=</span><span class="s1">&#39;runoff&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39; (mm/a)&#39;</span><span class="p">,</span>
                       <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax_ax2l</span><span class="p">),</span> <span class="n">target</span><span class="o">=</span><span class="n">obs_rs</span><span class="p">,</span> <span class="n">target_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                       <span class="n">ax</span><span class="o">=</span><span class="n">ax2l</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="n">rolling</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="s1">&#39;2000-12-31&#39;</span><span class="p">)</span>

        <span class="c1"># Plot evaporation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_cmip_ensemble</span><span class="p">(</span><span class="n">param_scenarios</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evaporation</span><span class="p">,</span> <span class="n">val_name</span><span class="o">=</span><span class="s1">&#39;eva&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39; (mm/a)&#39;</span><span class="p">,</span>
                       <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
                       <span class="n">ax</span><span class="o">=</span><span class="n">ax2l</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="n">rolling</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="s1">&#39;2000-12-31&#39;</span><span class="p">)</span>

        <span class="c1"># Plot precipitation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_cmip_ensemble</span><span class="p">(</span><span class="n">param_scenarios</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">precipitation</span><span class="p">,</span> <span class="n">val_name</span><span class="o">=</span><span class="s1">&#39;prec&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39; (mm/a)&#39;</span><span class="p">,</span>
                       <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_color</span><span class="o">=</span><span class="s1">&#39;darkgrey&#39;</span><span class="p">,</span>
                       <span class="n">ax</span><span class="o">=</span><span class="n">ax2l</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="n">rolling</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="s1">&#39;2000-12-31&#39;</span><span class="p">,</span> <span class="n">ylabel_pad</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">annote_final_val_lines</span><span class="p">(</span><span class="n">ax2l</span><span class="p">,</span> <span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1"># Add observation data rectangles</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
            <span class="n">ax2l</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">ymax_ax2l</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_obs_data&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="n">ax2l</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;salmon&#39;</span><span class="p">)</span>  <span class="c1"># Present day line</span>

        <span class="c1"># ----- Temperature (bottom panel) -----</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting temperature...&quot;</span><span class="p">)</span>
        <span class="n">ax3l</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># Process ERA5 temperature for plotting</span>
        <span class="k">if</span> <span class="n">rolling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">era5_temp_rs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_era5</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;YE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">rolling</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">era5_temp_rs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_era5</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;YE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_cmip_ensemble</span><span class="p">(</span><span class="n">param_scenarios</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tas</span><span class="p">,</span> <span class="n">val_name</span><span class="o">=</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Temp. (C)&#39;</span><span class="p">,</span>
                       <span class="n">target</span><span class="o">=</span><span class="n">era5_temp_rs</span><span class="p">,</span> <span class="n">target_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                       <span class="n">ax</span><span class="o">=</span><span class="n">ax3l</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="n">rolling</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="s1">&#39;2000-12-31&#39;</span><span class="p">,</span> <span class="n">intv_sum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel_pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">annote_final_val_lines</span><span class="p">(</span><span class="n">ax3l</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>

        <span class="c1"># Add 0C line</span>
        <span class="n">ax3l</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax3l</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;0 C&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>

        <span class="n">ax3l</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;salmon&#39;</span><span class="p">)</span>  <span class="c1"># Present day line</span>

        <span class="c1"># ----- Create legends -----</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating legends...&quot;</span><span class="p">)</span>

        <span class="c1"># Snow &amp; Ice melt legend</span>
        <span class="n">ax1l</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Snow Melt&#39;</span><span class="p">,</span> <span class="s1">&#39;Ice Melt&#39;</span><span class="p">,</span> <span class="s1">&#39;_Snow&#39;</span><span class="p">,</span> <span class="s1">&#39;_Ice&#39;</span><span class="p">,</span> <span class="s1">&#39;_White&#39;</span><span class="p">,</span> <span class="s1">&#39;SSP5-SSP2&#39;</span><span class="p">,</span> <span class="s1">&#39;SSP5-SSP2&#39;</span><span class="p">],</span> 
                <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Runoff, evaporation, precipitation legend</span>
        <span class="n">ax2l_legend</span> <span class="o">=</span> <span class="n">ax2l</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;_SSP2&#39;</span><span class="p">,</span> <span class="s1">&#39;Runoff&#39;</span><span class="p">,</span> <span class="s1">&#39;_SSP5&#39;</span><span class="p">,</span> <span class="s1">&#39;_CI5&#39;</span><span class="p">,</span> <span class="s1">&#39;_Runoff&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;_SSP2&#39;</span><span class="p">,</span> <span class="s1">&#39;Evaporation&#39;</span><span class="p">,</span> <span class="s1">&#39;_SSP5&#39;</span><span class="p">,</span> <span class="s1">&#39;_CI5&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;_SSP2&#39;</span><span class="p">,</span> <span class="s1">&#39;Precipitation&#39;</span><span class="p">,</span> <span class="s1">&#39;_SSP5&#39;</span><span class="p">,</span> <span class="s1">&#39;_CI5&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Runoff observation period&#39;</span><span class="p">],</span>
                      <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax2l_legend</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
        <span class="n">ax2l_legend</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

        <span class="c1"># Scenario legend</span>
        <span class="n">scenario_legend</span> <span class="o">=</span> <span class="n">ax3l</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;SSP2 Scenario&#39;</span><span class="p">,</span> <span class="s1">&#39;_ci1&#39;</span><span class="p">,</span> <span class="s1">&#39;SSP5 Scenario&#39;</span><span class="p">,</span> <span class="s1">&#39;_ci2&#39;</span><span class="p">],</span>
                        <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># ----- Add text annotations -----</span>
        <span class="n">style</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax1l</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;SSP5&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
        <span class="n">ax1l</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;SSP2&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
        <span class="n">ax1l</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2099</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">120</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Diff +&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
        <span class="n">ax1l</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2099</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Diff -&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rolling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax2l</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rolling</span><span class="si">}</span><span class="s2"> year rolling mean&quot;</span><span class="p">,</span> 
                  <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;italic&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>
            <span class="n">ax3l</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">era5_temp_rs</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> 
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rolling</span><span class="si">}</span><span class="s2"> year rolling mean&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;italic&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

        <span class="c1"># ----- Final formatting -----</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final formatting...&quot;</span><span class="p">)</span>

        <span class="n">ax3l</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">YearLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">None</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1l</span><span class="p">,</span> <span class="n">ax2l</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="n">ax3l</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MATILDA Summary&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># Save figure if path is provided</span>
        <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figure saved to </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; DONE! &lt;&lt;&quot;</span><span class="p">)</span>
                        
        <span class="k">return</span> <span class="n">figure</span>

<div class="viewcode-block" id="custom_df_matilda">
<a class="viewcode-back" href="../../modules.html#tools.plots.custom_df_matilda">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">custom_df_matilda</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">resample_freq</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a dictionary of model outputs and returns a combined dataframe of a specific variable for a given scenario.</span>
<span class="sd">    Parameters</span>
<span class="sd">    -------</span>
<span class="sd">    dic : dict</span>
<span class="sd">        A nested dictionary of model outputs.</span>
<span class="sd">        The outer keys are scenario names and the inner keys are model names.</span>
<span class="sd">        The corresponding values are dictionaries containing two keys:</span>
<span class="sd">        &#39;model_output&#39; (DataFrame): containing model outputs for a given scenario and model</span>
<span class="sd">        &#39;glacier_rescaling&#39; (DataFrame): containing glacier properties for a given scenario and model</span>
<span class="sd">    scenario : str</span>
<span class="sd">        The name of the scenario to select from the dictionary.</span>
<span class="sd">    var : str</span>
<span class="sd">        The name of the variable to extract from the model output DataFrame.</span>
<span class="sd">    resample_freq : str, optional</span>
<span class="sd">        The frequency of the resulting time series data.</span>
<span class="sd">        Defaults to None (i.e. no resampling).</span>
<span class="sd">        If provided, should be in pandas resample frequency string format.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        A DataFrame containing the combined data of the specified variable for the selected scenario</span>
<span class="sd">        and models. The DataFrame is indexed by the time steps of the original models.</span>
<span class="sd">        The columns are the names of the models in the selected scenario.</span>
<span class="sd">    Raises</span>
<span class="sd">    -------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the provided  var  string is not one of the following: [&#39;avg_temp_catchment&#39;, &#39;avg_temp_glaciers&#39;,</span>
<span class="sd">        &#39;evap_off_glaciers&#39;, &#39;prec_off_glaciers&#39;, &#39;prec_on_glaciers&#39;, &#39;rain_off_glaciers&#39;, &#39;snow_off_glaciers&#39;,</span>
<span class="sd">        &#39;rain_on_glaciers&#39;, &#39;snow_on_glaciers&#39;, &#39;snowpack_off_glaciers&#39;, &#39;soil_moisture&#39;, &#39;upper_groundwater&#39;,</span>
<span class="sd">        &#39;lower_groundwater&#39;, &#39;melt_off_glaciers&#39;, &#39;melt_on_glaciers&#39;, &#39;ice_melt_on_glaciers&#39;, &#39;snow_melt_on_glaciers&#39;,</span>
<span class="sd">        &#39;refreezing_ice&#39;, &#39;refreezing_snow&#39;, &#39;total_refreezing&#39;, &#39;SMB&#39;, &#39;actual_evaporation&#39;, &#39;total_precipitation&#39;,</span>
<span class="sd">        &#39;total_melt&#39;, &#39;runoff_without_glaciers&#39;, &#39;runoff_from_glaciers&#39;, &#39;runoff_ratio&#39;, &#39;total_runoff&#39;, &#39;glacier_area&#39;,</span>
<span class="sd">        &#39;glacier_elev&#39;, &#39;smb_water_year&#39;, &#39;smb_scaled&#39;, &#39;smb_scaled_capped&#39;, &#39;smb_scaled_capped_cum&#39;, &#39;surplus&#39;,</span>
<span class="sd">        &#39;glacier_melt_perc&#39;, &#39;glacier_mass_mmwe&#39;, &#39;glacier_vol_m3&#39;, &#39;glacier_vol_perc&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out1_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;avg_temp_catchment&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;avg_temp_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;evap_off_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;prec_off_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;prec_on_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;rain_off_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;snow_off_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;rain_on_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;snow_on_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;snowpack_off_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;soil_moisture&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;upper_groundwater&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;lower_groundwater&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;melt_off_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;melt_on_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;ice_melt_on_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;snow_melt_on_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;refreezing_ice&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;refreezing_snow&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;total_refreezing&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;SMB&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;actual_evaporation&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;total_precipitation&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;total_melt&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;runoff_without_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;runoff_from_glaciers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;runoff_ratio&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;total_runoff&#39;</span><span class="p">]</span>

    <span class="n">out2_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;glacier_area&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;glacier_elev&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;smb_water_year&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;smb_scaled&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;smb_scaled_capped&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;smb_scaled_capped_cum&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;surplus&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;glacier_melt_perc&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;glacier_mass_mmwe&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;glacier_vol_m3&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;glacier_vol_perc&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">out1_cols</span><span class="p">:</span>
        <span class="n">output_df</span> <span class="o">=</span> <span class="s1">&#39;model_output&#39;</span>
    <span class="k">elif</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">out2_cols</span><span class="p">:</span>
        <span class="n">output_df</span> <span class="o">=</span> <span class="s1">&#39;glacier_rescaling&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;var needs to be one of the following strings: &quot;</span> <span class="o">+</span>
                         <span class="nb">str</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">out1_cols</span><span class="p">,</span> <span class="n">out2_cols</span><span class="p">]]))</span>

    <span class="c1"># Create an empty list to store the dataframes</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Loop over the models in the selected scenario</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># Get the dataframe for the current model</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="n">scenario</span><span class="p">][</span><span class="n">model</span><span class="p">][</span><span class="n">output_df</span><span class="p">]</span>
        <span class="c1"># Append the dataframe to the list of dataframes</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
    <span class="c1"># Concatenate the dataframes into a single dataframe</span>
    <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Set the column names of the combined dataframe to the model names</span>
    <span class="n">combined_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="c1"># Resample time series</span>
    <span class="k">if</span> <span class="n">resample_freq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output_df</span> <span class="o">==</span> <span class="s1">&#39;glacier_rescaling&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resample_freq</span> <span class="o">==</span> <span class="s1">&#39;10YE&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;glacier_area&#39;</span><span class="p">,</span> <span class="s1">&#39;glacier_elev&#39;</span><span class="p">]:</span>
                    <span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">resample_freq</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">resample_freq</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;avg_temp_catchment&#39;</span><span class="p">,</span> <span class="s1">&#39;avg_temp_glaciers&#39;</span><span class="p">]:</span>
                <span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">resample_freq</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">resample_freq</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">combined_df</span></div>



<span class="kn">from</span><span class="w"> </span><span class="nn">tools.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">matilda_vars</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tools.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">confidence_interval</span>

<div class="viewcode-block" id="plot_ci_matilda">
<a class="viewcode-back" href="../../modules.html#tools.plots.plot_ci_matilda">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_ci_matilda</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">dic</span><span class="p">,</span> <span class="n">resample_freq</span><span class="o">=</span><span class="s1">&#39;YE&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function to plot multi-model mean and confidence intervals of a given variable for two different scenarios.</span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    var: str</span>
<span class="sd">        The variable to plot.</span>
<span class="sd">    dic: dict, optional (default=matilda_scenarios)</span>
<span class="sd">        A dictionary containing the scenarios as keys and the dataframes as values.</span>
<span class="sd">    resample_freq: str, optional (default=&#39;YE&#39;)</span>
<span class="sd">        The resampling frequency to apply to the data.</span>
<span class="sd">    show: bool, optional (default=False)</span>
<span class="sd">        Whether to show the resulting plot or not.</span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    go.Figure</span>
<span class="sd">        A plotly figure object containing the mean and confidence intervals for the given variable in the two selected scenarios.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;total_runoff&#39;</span>       <span class="c1"># Default if nothing selected</span>

    <span class="c1"># SSP2</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">custom_df_matilda</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="s1">&#39;SSP2&#39;</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">resample_freq</span><span class="o">=</span><span class="n">resample_freq</span><span class="p">)</span>
    <span class="n">df1_ci</span> <span class="o">=</span> <span class="n">confidence_interval</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
    <span class="c1"># SSP5</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">custom_df_matilda</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="s1">&#39;SSP5&#39;</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">resample_freq</span><span class="o">=</span><span class="n">resample_freq</span><span class="p">)</span>
    <span class="n">df2_ci</span> <span class="o">=</span> <span class="n">confidence_interval</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">([</span>
        <span class="c1"># SSP2</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SSP2&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df1_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df1_ci</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;95% CI Upper&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df1_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df1_ci</span><span class="p">[</span><span class="s1">&#39;ci_upper&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#444&#39;</span><span class="p">),</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">),</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;95% CI Lower&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df1_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df1_ci</span><span class="p">[</span><span class="s1">&#39;ci_lower&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#444&#39;</span><span class="p">),</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;rgba(255, 165, 0, 0.3)&#39;</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tonexty&#39;</span><span class="p">,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">),</span>

        <span class="c1"># SSP5</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SSP5&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df2_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df2_ci</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;95% CI Upper&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df2_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df2_ci</span><span class="p">[</span><span class="s1">&#39;ci_upper&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#444&#39;</span><span class="p">),</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">),</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;95% CI Lower&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df2_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df2_ci</span><span class="p">[</span><span class="s1">&#39;ci_lower&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#444&#39;</span><span class="p">),</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;rgba(0, 0, 255, 0.3)&#39;</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tonexty&#39;</span><span class="p">,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="n">matilda_vars</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; [&#39;</span> <span class="o">+</span> <span class="n">matilda_vars</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;b&gt;&#39;</span> <span class="o">+</span> <span class="n">matilda_vars</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/b&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;font&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;Arial&#39;</span><span class="p">}},</span>
        <span class="n">legend</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;font&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;Arial&#39;</span><span class="p">}},</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
        <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s1">&#39;rgba(255, 255, 255, 1)&#39;</span><span class="p">,</span>  <span class="c1"># Set the background color to white</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>  <span class="c1"># Adjust the margins to remove space around the plot</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">gridcolor</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">),</span>  <span class="c1"># set the grid color of x-axis to lightgrey</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">gridcolor</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">),</span>  <span class="c1"># set the grid color of y-axis to lightgrey</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">rangemode</span><span class="o">=</span><span class="s1">&#39;tozero&#39;</span><span class="p">)</span>

    <span class="c1"># show figure</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span></div>

    
    
<span class="k">def</span><span class="w"> </span><span class="nf">matilda_dash</span><span class="p">(</span><span class="n">app</span><span class="p">,</span><span class="n">dic</span><span class="p">,</span><span class="n">fig_count</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                 <span class="n">default_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_runoff&#39;</span><span class="p">,</span> <span class="s1">&#39;total_precipitation&#39;</span><span class="p">,</span> <span class="s1">&#39;runoff_from_glaciers&#39;</span><span class="p">,</span> <span class="s1">&#39;glacier_area&#39;</span><span class="p">],</span>
                 <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;inLine&#39;</span><span class="p">):</span>
    
    <span class="c1"># If number of default variables does not match the number of figures use variables in default order</span>
    <span class="k">if</span> <span class="n">fig_count</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_vars</span><span class="p">):</span>
        <span class="n">default_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matilda_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    
    <span class="c1"># Create separate callback functions for each dropdown menu and graph combination</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fig_count</span><span class="p">):</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
            <span class="n">Output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;line-plot-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
            <span class="n">Input</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;arg-dropdown-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
            <span class="n">Input</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;freq-dropdown-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">update_figure</span><span class="p">(</span><span class="n">selected_arg</span><span class="p">,</span> <span class="n">selected_freq</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_ci_matilda</span><span class="p">(</span><span class="n">selected_arg</span><span class="p">,</span><span class="n">dic</span><span class="o">=</span><span class="n">dic</span><span class="p">,</span> <span class="n">resample_freq</span><span class="o">=</span><span class="n">selected_freq</span><span class="o">+</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>  <span class="c1"># adding &#39;E&#39; to resample freq due to deprecated warning (e.g. &#39;YE&#39; instead of &#39;Y&#39;)</span>
            <span class="k">return</span> <span class="n">fig</span>

    <span class="c1"># Define the dropdown menus and figures</span>
    <span class="n">dropdowns_and_figures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fig_count</span><span class="p">):</span>
        <span class="n">arg_dropdown</span> <span class="o">=</span> <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;arg-dropdown-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">matilda_vars</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">}</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">matilda_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span>
            <span class="n">value</span><span class="o">=</span><span class="n">default_vars</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">clearable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="s1">&#39;400px&#39;</span><span class="p">,</span> <span class="s1">&#39;fontFamily&#39;</span><span class="p">:</span> <span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="s1">&#39;fontSize&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">freq_dropdown</span> <span class="o">=</span> <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;freq-dropdown-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">freq</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">freq</span><span class="p">}</span> <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;10Y&#39;</span><span class="p">]],</span>
            <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span>
            <span class="n">clearable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="s1">&#39;100px&#39;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">dropdowns_and_figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                    <span class="n">html</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s2">&quot;Variable:&quot;</span><span class="p">),</span>
                    <span class="n">arg_dropdown</span><span class="p">,</span>
                <span class="p">],</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;inline-block&#39;</span><span class="p">,</span> <span class="s1">&#39;margin-right&#39;</span><span class="p">:</span> <span class="s1">&#39;30px&#39;</span><span class="p">}),</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                    <span class="n">html</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s2">&quot;Frequency:&quot;</span><span class="p">),</span>
                    <span class="n">freq_dropdown</span><span class="p">,</span>
                <span class="p">],</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;inline-block&#39;</span><span class="p">}),</span>
                <span class="n">dcc</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;line-plot-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
            <span class="p">])</span>
        <span class="p">)</span>
    <span class="c1"># Combine the dropdown menus and figures into a single layout</span>
    <span class="n">app</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="n">dropdowns_and_figures</span><span class="p">)</span>


<div class="viewcode-block" id="plot_ci_indicators">
<a class="viewcode-back" href="../../modules.html#tools.plots.plot_ci_indicators">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_ci_indicators</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">dic</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function to plot multi-model mean and confidence intervals of a given variable for two different scenarios.</span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    var: str</span>
<span class="sd">        The variable to plot.</span>
<span class="sd">    dic: dict, optional (default=matilda_scenarios)</span>
<span class="sd">        A dictionary containing the scenarios as keys and the dataframes as values.</span>
<span class="sd">    plot_type: str, optional (default=&#39;line&#39;)</span>
<span class="sd">        Whether the plot should be a line or a bar plot.</span>
<span class="sd">    show: bool, optional (default=False)</span>
<span class="sd">        Whether to show the resulting plot or not.</span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    go.Figure</span>
<span class="sd">        A plotly figure object containing the mean and confidence intervals for the given variable in the two selected scenarios.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;total_runoff&#39;</span>       <span class="c1"># Default if nothing selected</span>

    <span class="c1"># SSP2</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">custom_df_indicators</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="s1">&#39;SSP2&#39;</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>
    <span class="n">df1_ci</span> <span class="o">=</span> <span class="n">confidence_interval</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
    <span class="c1"># SSP5</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">custom_df_indicators</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="s1">&#39;SSP5&#39;</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>
    <span class="n">df2_ci</span> <span class="o">=</span> <span class="n">confidence_interval</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">([</span>
        <span class="c1"># SSP2</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SSP2&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df1_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df1_ci</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;95% CI Upper&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df1_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df1_ci</span><span class="p">[</span><span class="s1">&#39;ci_upper&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#444&#39;</span><span class="p">),</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">),</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;95% CI Lower&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df1_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df1_ci</span><span class="p">[</span><span class="s1">&#39;ci_lower&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#444&#39;</span><span class="p">),</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;rgba(255, 165, 0, 0.3)&#39;</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tonexty&#39;</span><span class="p">,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">),</span>

        <span class="c1"># SSP5</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SSP5&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df2_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df2_ci</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;95% CI Upper&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df2_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df2_ci</span><span class="p">[</span><span class="s1">&#39;ci_upper&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#444&#39;</span><span class="p">),</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">),</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;95% CI Lower&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df2_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df2_ci</span><span class="p">[</span><span class="s1">&#39;ci_lower&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#444&#39;</span><span class="p">),</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;rgba(0, 0, 255, 0.3)&#39;</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tonexty&#39;</span><span class="p">,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="p">])</span>
    <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">([</span>
            <span class="c1"># SSP2</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SSP2&#39;</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="n">df1_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df1_ci</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">),</span>
                <span class="n">error_y</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">symmetric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">array</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df1_ci</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df1_ci</span><span class="p">[</span><span class="s1">&#39;ci_lower&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">arrayminus</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df1_ci</span><span class="p">[</span><span class="s1">&#39;ci_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df1_ci</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="c1"># SSP5</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SSP5&#39;</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="n">df2_ci</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df2_ci</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">),</span>
                <span class="n">error_y</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">symmetric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">array</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df2_ci</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df2_ci</span><span class="p">[</span><span class="s1">&#39;ci_lower&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">arrayminus</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">df2_ci</span><span class="p">[</span><span class="s1">&#39;ci_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df2_ci</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid property specified for &#39;plot_type&#39;. Choose either &#39;line&#39; or &#39;bar&#39;&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="n">indicator_vars</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; [&#39;</span> <span class="o">+</span> <span class="n">indicator_vars</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;b&gt;&#39;</span> <span class="o">+</span> <span class="n">indicator_vars</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/b&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;font&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;Palatino&#39;</span><span class="p">}},</span>
        <span class="n">legend</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;font&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;Palatino&#39;</span><span class="p">}},</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
        <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s1">&#39;rgba(255, 255, 255, 1)&#39;</span><span class="p">,</span>  <span class="c1"># Set the background color to white</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>  <span class="c1"># Adjust the margins to remove space around the plot</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">gridcolor</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">),</span>  <span class="c1"># set the grid color of x-axis to lightgrey</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">gridcolor</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">),</span>  <span class="c1"># set the grid color of y-axis to lightgrey</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">rangemode</span><span class="o">=</span><span class="s1">&#39;tozero&#39;</span><span class="p">)</span>

    <span class="c1"># show figure</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span></div>

    

<span class="k">def</span><span class="w"> </span><span class="nf">matilda_indicators_dash</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">indicator_data</span><span class="p">,</span> <span class="n">fig_count</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                             <span class="n">default_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;peak_day&#39;</span><span class="p">,</span> <span class="s1">&#39;melt_season_length&#39;</span><span class="p">,</span> <span class="s1">&#39;potential_aridity&#39;</span><span class="p">,</span> <span class="s1">&#39;spei12&#39;</span><span class="p">],</span>
                             <span class="n">default_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">]):</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fig_count</span><span class="p">):</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
            <span class="n">Output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;line-plot-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
            <span class="n">Input</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;arg-dropdown-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
            <span class="n">Input</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;type-dropdown-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">update_figure</span><span class="p">(</span><span class="n">selected_arg</span><span class="p">,</span> <span class="n">selected_type</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_ci_indicators</span><span class="p">(</span><span class="n">selected_arg</span><span class="p">,</span> <span class="n">indicator_data</span><span class="p">,</span> <span class="n">selected_type</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fig</span>

    <span class="n">dropdowns_and_figures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fig_count</span><span class="p">):</span>
        <span class="n">arg_dropdown</span> <span class="o">=</span> <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;arg-dropdown-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">indicator_vars</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">}</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">indicator_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span>
            <span class="n">value</span><span class="o">=</span><span class="n">default_vars</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">clearable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="s1">&#39;400px&#39;</span><span class="p">,</span> <span class="s1">&#39;fontFamily&#39;</span><span class="p">:</span> <span class="s1">&#39;Palatino&#39;</span><span class="p">,</span> <span class="s1">&#39;fontSize&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">type_dropdown</span> <span class="o">=</span> <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;type-dropdown-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">lab</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span> <span class="k">for</span> <span class="n">lab</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;Line&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Bar&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)]],</span>
            <span class="n">value</span><span class="o">=</span><span class="n">default_types</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">clearable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="s1">&#39;150px&#39;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">dropdowns_and_figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                    <span class="n">html</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s2">&quot;Variable:&quot;</span><span class="p">),</span>
                    <span class="n">arg_dropdown</span><span class="p">,</span>
                <span class="p">],</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;inline-block&#39;</span><span class="p">,</span> <span class="s1">&#39;margin-right&#39;</span><span class="p">:</span> <span class="s1">&#39;30px&#39;</span><span class="p">}),</span>
                <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
                    <span class="n">html</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s2">&quot;Plot Type:&quot;</span><span class="p">),</span>
                    <span class="n">type_dropdown</span><span class="p">,</span>
                <span class="p">],</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;inline-block&#39;</span><span class="p">}),</span>
                <span class="n">dcc</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;line-plot-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
            <span class="p">])</span>
        <span class="p">)</span>
    
    <span class="n">app</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span><span class="n">dropdowns_and_figures</span><span class="p">)</span>


<div class="viewcode-block" id="ensemble_mean">
<a class="viewcode-back" href="../../modules.html#tools.plots.ensemble_mean">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ensemble_mean</span><span class="p">(</span><span class="n">matilda_scenarios</span><span class="p">,</span> <span class="n">result_name</span><span class="p">,</span> <span class="n">dict_name</span><span class="o">=</span><span class="s2">&quot;model_output&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the ensemble mean for a specific variable across all models in the scenarios.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        matilda_scenarios (dict): Original scenario dictionary with nested model outputs.</span>
<span class="sd">        result_name (str): Name of the target variable to extract (e.g., &#39;total_runoff&#39;).</span>
<span class="sd">        dict_name (str): Name of the dictionary in the model output to look for results (default: &#39;model_output&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary with emission scenarios as keys and the ensemble mean time series (as pandas Series) as values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_matilda_result_all_models</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">result_name</span><span class="p">,</span> <span class="n">dict_name</span><span class="o">=</span><span class="s2">&quot;model_output&quot;</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">matilda_scenarios</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">dict_name</span><span class="p">][</span><span class="n">result_name</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">key</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">s</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;TIMESTAMP&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result_name</span><span class="si">}</span><span class="s2"> extracted for </span><span class="si">{</span><span class="n">scenario</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="c1"># Extract the result data for each scenario and compute the ensemble mean</span>
    <span class="n">mean_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="n">matilda_scenarios</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># Get the DataFrame of all models for the given scenario and variable</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">get_matilda_result_all_models</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">result_name</span><span class="p">,</span> <span class="n">dict_name</span><span class="p">)</span>
        <span class="c1"># Compute the ensemble mean across models (columns)</span>
        <span class="n">mean_results</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mean_results</span></div>



<div class="viewcode-block" id="plot_annual_cycles">
<a class="viewcode-back" href="../../modules.html#tools.plots.plot_annual_cycles">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_annual_cycles</span><span class="p">(</span><span class="n">matilda_scenarios</span><span class="p">,</span> <span class="n">scenarios</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;SSP2&quot;</span><span class="p">,</span> <span class="s2">&quot;SSP5&quot;</span><span class="p">),</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a 2-column by 4-row plot of annual cycles for the given variables,</span>
<span class="sd">    comparing two scenarios side by side.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        runoff (dict): Ensemble mean dictionary for runoff.</span>
<span class="sd">        snow_melt (dict): Ensemble mean dictionary for snowmelt.</span>
<span class="sd">        ice_melt (dict): Ensemble mean dictionary for ice melt.</span>
<span class="sd">        aet (dict): Ensemble mean dictionary for actual evaporation.</span>
<span class="sd">        scenarios (tuple): Tuple of two scenarios to compare (default: (&quot;SSP2&quot;, &quot;SSP5&quot;))</span>

<span class="sd">    Returns:</span>
<span class="sd">        None: Displays the subplot figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">runoff</span> <span class="o">=</span> <span class="n">ensemble_mean</span><span class="p">(</span><span class="n">matilda_scenarios</span><span class="p">,</span> <span class="s2">&quot;total_runoff&quot;</span><span class="p">)</span>
    <span class="n">snow_melt</span> <span class="o">=</span> <span class="n">ensemble_mean</span><span class="p">(</span><span class="n">matilda_scenarios</span><span class="p">,</span> <span class="s2">&quot;snow_melt_on_glaciers&quot;</span><span class="p">)</span>
    <span class="n">ice_melt</span> <span class="o">=</span> <span class="n">ensemble_mean</span><span class="p">(</span><span class="n">matilda_scenarios</span><span class="p">,</span> <span class="s2">&quot;ice_melt_on_glaciers&quot;</span><span class="p">)</span>
    <span class="n">off_melt</span> <span class="o">=</span> <span class="n">ensemble_mean</span><span class="p">(</span><span class="n">matilda_scenarios</span><span class="p">,</span> <span class="s2">&quot;melt_off_glaciers&quot;</span><span class="p">)</span>
    <span class="n">aet</span> <span class="o">=</span> <span class="n">ensemble_mean</span><span class="p">(</span><span class="n">matilda_scenarios</span><span class="p">,</span> <span class="s2">&quot;actual_evaporation&quot;</span><span class="p">)</span>

    <span class="c1"># Melt off glacier is always snow melt:</span>
    <span class="n">snow_melt</span><span class="p">[</span><span class="s2">&quot;SSP2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snow_melt</span><span class="p">[</span><span class="s2">&quot;SSP2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">off_melt</span><span class="p">[</span><span class="s2">&quot;SSP2&quot;</span><span class="p">]</span>
    <span class="n">snow_melt</span><span class="p">[</span><span class="s2">&quot;SSP5&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snow_melt</span><span class="p">[</span><span class="s2">&quot;SSP5&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">off_melt</span><span class="p">[</span><span class="s2">&quot;SSP5&quot;</span><span class="p">]</span>
    
    <span class="n">variables</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Total Runoff&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;YlGnBu&quot;</span><span class="p">,</span> <span class="n">runoff</span><span class="p">),</span>
        <span class="s2">&quot;Snowmelt&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="n">snow_melt</span><span class="p">),</span>
        <span class="s2">&quot;Ice Melt&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="n">ice_melt</span><span class="p">),</span>
        <span class="s2">&quot;AET&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Oranges&quot;</span><span class="p">,</span> <span class="n">aet</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">short_month_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span> <span class="s2">&quot;Feb&quot;</span><span class="p">,</span> <span class="s2">&quot;Mar&quot;</span><span class="p">,</span> <span class="s2">&quot;Apr&quot;</span><span class="p">,</span> <span class="s2">&quot;May&quot;</span><span class="p">,</span> <span class="s2">&quot;Jun&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;Jul&quot;</span><span class="p">,</span> <span class="s2">&quot;Aug&quot;</span><span class="p">,</span> <span class="s2">&quot;Sep&quot;</span><span class="p">,</span> <span class="s2">&quot;Oct&quot;</span><span class="p">,</span> <span class="s2">&quot;Nov&quot;</span><span class="p">,</span> <span class="s2">&quot;Dec&quot;</span><span class="p">]</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">var_dict</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">for</span> <span class="n">col_idx</span><span class="p">,</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scenarios</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">var_dict</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span>

            <span class="c1"># Prepare the data</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>

            <span class="c1"># Group and pivot</span>
            <span class="n">monthly_values</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">])[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">monthly_values</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">var_name</span><span class="p">)</span>

            <span class="c1"># Plot</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

            <span class="c1"># Colorbar</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="p">[</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
            <span class="p">])</span>
            <span class="n">c</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;mm&quot;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">13</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

            <span class="c1"># Titles and labels</span>
            <span class="k">if</span> <span class="n">col_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

            <span class="c1"># Customizing ticks</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span> <span class="s2">&quot;Jul&quot;</span><span class="p">,</span> <span class="s2">&quot;Dec&quot;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;2000&quot;</span><span class="p">,</span> <span class="s2">&quot;2050&quot;</span><span class="p">,</span> <span class="s2">&quot;2100&quot;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figure saved to </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_sensitivity_bars">
<a class="viewcode-back" href="../../modules.html#tools.plots.plot_sensitivity_bars">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_sensitivity_bars</span><span class="p">(</span><span class="o">*</span><span class="n">dfs</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bar_width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">bar_gap</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots a horizontal bar chart showing the total sensitivity index for each parameter in a MATILDA model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *dfs : pandas.DataFrame</span>
<span class="sd">        Multiple dataframes containing the sensitivity indices for each parameter.</span>
<span class="sd">    labels : list of str, optional</span>
<span class="sd">        Labels to use for the different steps in the sensitivity analysis. If not provided, the default</span>
<span class="sd">        labels will be &#39;No Limits&#39;, &#39;Step 1&#39;, &#39;Step 2&#39;, etc.</span>
<span class="sd">    bar_width : float, optional</span>
<span class="sd">        Width of each bar in the chart.</span>
<span class="sd">    bar_gap : float, optional</span>
<span class="sd">        Space between bars.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;cyan&#39;</span><span class="p">]</span>   <span class="c1"># add more colors if needed</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfs</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">get_si</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Step &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;No Limits&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                       <span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ST&#39;</span><span class="p">],</span>
                       <span class="n">name</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                       <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span>
                       <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                       <span class="n">width</span><span class="o">=</span><span class="n">bar_width</span><span class="p">)</span>
        <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;&lt;b&gt;&#39;</span> <span class="o">+</span><span class="s1">&#39;Total Sensitivity Index for MATILDA Parameters&#39;</span> <span class="o">+</span> <span class="s1">&#39;&lt;b&gt;&#39;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="p">)),</span>
                   <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Total Sensitivity Index&#39;</span><span class="p">,</span>
                   <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Parameter&#39;</span><span class="p">,</span>
                   <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                   <span class="n">bargap</span><span class="o">=</span><span class="n">bar_gap</span><span class="p">,</span>
                   <span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">traces</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Alexander Georgi, Phillip Schuster, Mia Janzen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>